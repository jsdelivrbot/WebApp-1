<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebApp</title>
<!-- link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.0.1.css" -->
<link rel="stylesheet" href="qunit-2.0.1.css">
</head>

<body>

<div style="border: 1px solid gray; padding: .4em;">
	<button onclick="window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname);">Retest</button>
</div>

<div class="page" id="firstPage">
	<h1>WebApp - <span style="color:#004;">First Page</span></h1>
	<p>If you are viewing this page (firstPage), it means that the current browser URL ends with "/index.html#firstPage"</p>
	#firstPage | <a href="#secondPage">#secondPage</a> | <a href="#thirdPage">#thirdPage</a>
</div>

<div class="page" id="secondPage">
	<h1>WebApp - <span style="color:#040;">Second Page</span></h1>
	<p>If you are viewing this page (secondPage), it means that the current browser URL ends with "/index.html#secondPage"</p>
	<a href="#firstPage">#firstPage</a> | #secondPage | <a href="#thirdPage">#thirdPage</a>
</div>

<div class="page" id="thirdPage">
	<h1>WebApp - <span style="color:#400;">Third Page</span></h1>
	<p>If you are viewing this page (thirdPage), it means that the current browser URL ends with "/index.html#thirdPage"</p>
	<a href="#firstPage">#firstPage</a> | <a href="#secondPage">#secondPage</a> | #thirdPage
</div>

<br>
<div id="qunit"></div>
<div id="qunit-fixture"></div>

<!-- script src="https://cdn.rawgit.com/samereberlin/WebApp/master/www/WebApp.js"></script -->
<script src="WebApp.js"></script>

<!-- script src="https://code.jquery.com/qunit/qunit-2.0.1.js"></script -->
<script src="qunit-2.0.1.js"></script>

<script>
var testCaseIndex = 0;
var testTimeout = null;
var timeoutDelay = 10;
var timeoutLong = 5000;
QUnit.config.testTimeout = timeoutLong;

function startNext() {
	clearTimeout(testTimeout);
	if (testCases[testCaseIndex]) {
		testTimeout = setTimeout(function() {
			throw 'Test timed out, testCaseIndex: ' + testCaseIndex;
		}, timeoutLong);
		testCases[testCaseIndex++]();
	}
}

function setTestPage(testTitle, pageId, historyStackLength, callback) {
	WebApp.onSwitchPage = function() {
		WebApp.onSwitchPage = null;
		QUnit.test(testTitle, function(assert) {
			testPage(assert, pageId, historyStackLength);
			if (typeof callback === 'function') callback(assert);
		});
	};
}

function testPage(assert, pageId, historyStackLength) {
	assert.equal(window.location.hash, '#' + pageId, 'Page hash: #' + pageId);
	var pageElements = WebApp.getPageElements();
	for (var pageElement in pageElements) {
		assert.equal(pageElements[pageElement].style.display, (pageElement === pageId? 'block': 'none'), pageElement + 'style display: ' + pageElements[pageElement].style.display);
	}
	assert.equal(WebApp.getHistoryStack().length, historyStackLength, 'History stack length: ' + historyStackLength);
}

function testUnknownHash(assert, currentHash, callback) {
	WebApp.onUpdateHash = function(hashChangeEvent) {
		WebApp.onUpdateHash = function(hashChangeEvent) {
			var newHash = hashChangeEvent.newURL.substr(hashChangeEvent.newURL.lastIndexOf('#'));
			if (currentHash === hashChangeEvent.newURL.substr(hashChangeEvent.newURL.lastIndexOf('#') + 1)) {
				WebApp.onUpdateHash = null;
				assert.equal(hashChangeEvent.oldURL.substr(hashChangeEvent.oldURL.lastIndexOf('#') + 1), 'unknown', 'Test "unknown" hash, oldHash: #unknown');
				assert.equal(hashChangeEvent.newURL.substr(hashChangeEvent.newURL.lastIndexOf('#') + 1), currentHash, 'Test "unknown" hash, newHash: #' + currentHash);
				if (typeof callback === 'function') callback(assert);
			}
		};
	};
	window.location.hash = 'unknown';
}

var testCases = [
	function() {
		var testEmptyStartupHash = window.location.hash;
		var testEmptyHistoryStack = WebApp.getHistoryStack().length;
		QUnit.test('Startup verifications...', function(assert) {
			assert.equal(testEmptyStartupHash, '', 'Empty URL hash.');
			assert.equal(testEmptyHistoryStack, 0, 'Empty history stack.');
		});
		startNext();
	},
	function() {
		setTestPage('First page redirection, from empty hash...', 'firstPage', 1, startNext);
	},
	function() {
		setTestPage('First page redirection, from unknown hash...', 'firstPage', 1, startNext);
		setTimeout(function() { 
			WebApp.reset();
			window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#unknown');
		}, timeoutDelay);
	},
	function() {
		setTestPage('Default page redirection, from empty hash...', 'secondPage', 1, startNext);
		WebApp.setDefaultPageId('secondPage');
		setTimeout(function() {
			WebApp.reset();
			window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#');
		}, timeoutDelay);
	},
	function() {
		setTestPage('Default page redirection, from unknown hash...', 'firstPage', 1, startNext);
		WebApp.setDefaultPageId('firstPage');
		setTimeout(function() {
			WebApp.reset();
			window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#unknown');
		}, timeoutDelay);
	},
	function() {
		QUnit.test('Previous page redirection, from unknown hash...', function(assert) {
			var done = assert.async();
			testPage(assert, 'firstPage', 1);
			testUnknownHash(assert, 'firstPage', function() {
				testPage(assert, 'firstPage', 1);
				done();
				startNext();
			});
		});
	},
	function() {
		// 2nd: window.history.length = (1st-> 2nd).
		// `-----,
		//(1st) 2nd.
		QUnit.test('History stack management (default firstly)...', function(assert) {
			var done = assert.async();
			WebApp.onSwitchPage = function() {
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = function() {
						WebApp.onSwitchPage = null;
						testPage(assert, 'firstPage', 1);
						done();
						startNext();
					};
					testPage(assert, 'secondPage', 2);
					window.history.back();
				};
				testPage(assert, 'firstPage', 1);
			};
			setTimeout(function() { 
				WebApp.unload();
				window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#secondPage');
				WebApp.load();
			}, timeoutDelay);
		});
	},
	function() {
		// 1st-> 2nd-> 3rd-> 2nd-> 1st: window.history.length = (1st-> 2nd-> 1st) = historyLength (1st-> unknown) + 1.
		//       ,-----------<´
		//(1st) 2nd-> 1st.
		//  `---------<´
		QUnit.test('History stack management (next/previous)...', function(assert) {
			var done = assert.async();
			testUnknownHash(assert, 'firstPage', function() { // Required to reset window.history.length
				var historyLength = window.history.length;
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = function() {
						WebApp.onSwitchPage = function() {
							WebApp.onSwitchPage = function() {
								WebApp.onSwitchPage = null;
								testPage(assert, 'firstPage', 1);
								assert.equal(window.history.length, historyLength + 1, 'window.history.length: ' + (historyLength + 1));
								done();
								startNext();
							};
							testPage(assert, 'secondPage', 2);
							setTimeout(function() {window.location.hash = 'firstPage';}, timeoutDelay);
						};
						testPage(assert, 'thirdPage', 3);
						setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
					};
					testPage(assert, 'secondPage', 2);
					setTimeout(function() {window.location.hash = 'thirdPage';}, timeoutDelay);
				};
				testPage(assert, 'firstPage', 1);
				setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
			});
		});
	},
	function() {
		// 1st-> 2nd-> 3rd-> 1st: window.history.length = (1st-> 2nd-> 3rd-> 1st) = historyLength (1st-> unknown) + 2.
		//  ,-----------------´
		// 1st  (2nd) (3rd) (1st).
		QUnit.test('History stack management (unique entry)...', function(assert) {
			var done = assert.async();
			testUnknownHash(assert, 'firstPage', function() { // Required to reset window.history.length
				var historyLength = window.history.length;
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = function() {
						WebApp.onSwitchPage = function() {
							WebApp.onSwitchPage = null;
							testPage(assert, 'firstPage', 1);
							assert.equal(window.history.length, historyLength + 2, 'window.history.length: ' + (historyLength + 2));
							done();
							startNext();
						};
						testPage(assert, 'thirdPage', 3);
						setTimeout(function() {window.location.hash = 'firstPage';}, timeoutDelay);
					};
					testPage(assert, 'secondPage', 2);
					setTimeout(function() {window.location.hash = 'thirdPage';}, timeoutDelay);
				};
				testPage(assert, 'firstPage', 1);
				setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
			});
		});
	},
	function() {
		// 2nd: window.history.length = (1st-> 2nd).
		// `-----,
		//(1st) 2nd.
		QUnit.test('History stack management (default firstly FALSE)...', function(assert) {
			var done = assert.async();
			WebApp.setDefaultPageFirstly(false);
			WebApp.onSwitchPage = function() {
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = null;
					testPage(assert, 'firstPage', 1);
					done();
					startNext();
				};
				testPage(assert, 'secondPage', 1);
				setTimeout(function() { // Required to restore the initial state (#firstPage).
					WebApp.reset();
					WebApp.setDefaultPageFirstly(true);
					window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#firstPage');
				}, timeoutDelay);
			};
			setTimeout(function() { 
				WebApp.unload();
				window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#secondPage');
				WebApp.load();
			}, timeoutDelay);
		});
	},
	function() {
		// 1st-> 2nd-> 3rd-> 2nd-> 1st: window.history.length = (1st-> 2nd-> 3rd-> 2nd-> 1st) = historyLength (1st-> unknown) + 3.
		//       ,-----X-----<´
		//(1st) 2nd-> 1st.
		//  `----X----<´
		QUnit.test('History stack management (next/previous FALSE)...', function(assert) {
			var done = assert.async();
			WebApp.setHistoryManaged(false);
			testUnknownHash(assert, 'firstPage', function() { // Required to reset window.history.length
				var historyLength = window.history.length;
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = function() {
						WebApp.onSwitchPage = function() {
							WebApp.onSwitchPage = function() {
								WebApp.onSwitchPage = null;
								testPage(assert, 'firstPage', 1);
								assert.equal(window.history.length, historyLength + 3, 'window.history.length: ' + (historyLength + 3));
								window.history.go(-4); // Required to restore the initial state (#firstPage).
								WebApp.setHistoryManaged(true);
								done();
								startNext();
							};
							testPage(assert, 'secondPage', 1);
							setTimeout(function() {window.location.hash = 'firstPage';}, timeoutDelay);
						};
						testPage(assert, 'thirdPage', 1);
						setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
					};
					testPage(assert, 'secondPage', 1);
					setTimeout(function() {window.location.hash = 'thirdPage';}, timeoutDelay);
				};
				testPage(assert, 'firstPage', 1);
				setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
			});
		});
	},
	function() {
		// 1st-> 2nd-> 3rd-> 1st: window.history.length = (1st-> 2nd-> 3rd-> 1st) = historyLength (1st-> unknown) + 2.
		//  ,--------X--------´
		// 1st  (2nd) (3rd) (1st).
		QUnit.test('History stack management (unique entry FALSE)...', function(assert) {
			var done = assert.async();
			WebApp.setHistoryUnique(false);
			testUnknownHash(assert, 'firstPage', function() { // Required to reset window.history.length
				var historyLength = window.history.length;
				WebApp.onSwitchPage = function() {
					WebApp.onSwitchPage = function() {
						WebApp.onSwitchPage = function() {
							WebApp.onSwitchPage = function() {
								WebApp.onSwitchPage = null;
								testPage(assert, 'firstPage', 1);
								done();
								startNext();
							};
							testPage(assert, 'firstPage', 4);
							assert.equal(window.history.length, historyLength + 2, 'window.history.length: ' + (historyLength + 2));
							setTimeout(function() { // Required to restore the initial state (#firstPage).
								window.history.go(-3);
								WebApp.reset();
								WebApp.setHistoryUnique(true);
								window.location.replace(window.location.protocol + '//' + window.location.host + window.location.pathname + '#');
							}, timeoutDelay);
						};
						testPage(assert, 'thirdPage', 3);
						setTimeout(function() {window.location.hash = 'firstPage';}, timeoutDelay);
					};
					testPage(assert, 'secondPage', 2);
					setTimeout(function() {window.location.hash = 'thirdPage';}, timeoutDelay);
				};
				testPage(assert, 'firstPage', 1);
				setTimeout(function() {window.location.hash = 'secondPage';}, timeoutDelay);
			});
		});
	},




];

startNext();
</script>

</body>

</html>
